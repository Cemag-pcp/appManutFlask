{% extends "user/layout.html" %}
{% block body %}

{% block voltar %}
{% endblock %}

<div class="col-md-4 offset-md-4">
  {% with messages = get_flashed_messages()  %}
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">×</span>
    </button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}
</div>

  <div class="col-md-4 offset-md-4">
    <div id ="formulario_abertura" class="card card-body">
      <div id = 'abertura_titulo' class="row justify-content-center align-items-center mb-3">
        <h3>Abrir OS</h3>
      </div>  
      <form action="{{url_for('routes.add_student')}}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="setor">Setor</label>
          <select class="form-control" id="setor" name="setor" onchange="getMaquinasPorSetor()">
            <option value="" selected disabled hidden></option>
            <option value="Administrativo">Administrativo</option>
            <option value="Estamparia">Estamparia</option>
            <option value="Solda">Solda</option>
            <option value="Montagem">Montagem</option>
            <option value="Pintura">Pintura</option>
            <option value="Carpintaria">Carpintaria</option>
            <option value="Almoxarifado">Almoxarifado</option>
            <option value="Usinagem">Usinagem</option>
            <option value="Serra">Serra</option>
            <option value="Corte">Corte</option>
            <option value="Serralheria">Serralheria</option>
            <option value="Manutenção">Manutenção</option>
          </select>
        </div>

        <div class="form-group" id="maquina-select">
          <label for="maquina">Máquina/Local:</label>
          <select class="form-control" data-live-search="true" name="maquina" id="maquina">
            <option value="" selected disabled hidden></option>  
            {% for maquina in lista_maquinas %}
            <option value="{{maquina[0]}}">{{maquina[0]}}</option>
            {% endfor %}
          </select>
        </div>
         
        <div class="form-group">
          <label for="problema">Descrição:</label>
          <textarea id="problema" name="problema" rows="5" cols="39" required placeholder=" Descreva o problema..."></textarea>
        </div>

        <div class="form-group">
          <label for="maquina-parada">Máquina parada?</label>
          <label class="switch">
            <input type="checkbox" name="maquina-parada" id="maquina-parada">
            <span class="slider round"></span>
          </label>
        </div>

        <div class="form-group">        
          <label for="risco">Impacto na produção:</label>
          <select class="form-control form-control" id="risco" name="risco" required>
              <option value="" selected disabled hidden></option>  
              <option>Alto</option>
              <option>Médio</option>
              <option>Baixo</option>
          </select>
        </div>

        <div class="form-group">        
          <label for="imagem">Imagem:</label>
          <input type="file" class="form-control-file" id="imagem" name="imagem">
        </div>

        <button id = 'salvar' class="btn btn-block">
          Save 
        </button>
        
      </form>
    </div>
  </div>
</div>

<script>
  function getMaquinasPorSetor() {
    var setorSelect = document.getElementById('setor');
    var maquinaSelect = document.getElementById('maquina');
    var setorSelecionado = setorSelect.value;

    // Limpa as opções atuais do menu de máquinas
    maquinaSelect.innerHTML = '<option value="" selected disabled hidden></option>';

    // Verifica se um setor foi selecionado
    if (setorSelecionado !== '') {
      // Faz uma chamada assíncrona para o servidor Flask
      $.ajax({
        url: '/maquinas/' + setorSelecionado,
        type: 'GET',
        success: function(data) {
          // Atualiza o menu de máquinas com as opções retornadas do servidor
          for (var i = 0; i < data.length; i++) {
            var option = document.createElement('option');
            option.text = data[i];
            option.value = data[i];
            maquinaSelect.add(option);
          }
        }
      });
    }
  }
</script>

<!-- Inicialize o Bootstrap Select -->
<script>
  $(document).ready(function() {
    $('#maquina').select2({
      placeholder: 'Pesquisar máquina',
      allowClear: true,
      width: '100%',
    });
  });
</script>

<script>
  var maquinaParadaCheckbox = document.getElementById('maquina-parada');
  var maquinaParadaHiddenInput = document.querySelector('input[name="maquina-parada"][type="hidden"]');

  maquinaParadaCheckbox.addEventListener('change', function() {
    if (this.checked) {
      maquinaParadaHiddenInput.value = "true";
    } else {
      maquinaParadaHiddenInput.value = "false";
    }
  });
</script>

{% endblock %}